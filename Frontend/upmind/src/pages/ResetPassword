// src/pages/ResetPasswordPage.jsx
import { useRef, useState, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import ResetPasswordView from "../components/ResetPassword/ResetPassword";

const CODE_LENGTH = 6;

export default function ResetPasswordPage() {
  const [code, setCode] = useState(Array(CODE_LENGTH).fill(""));
  const [newPassword, setNewPassword] = useState("");
  const [confirm, setConfirm] = useState("");

  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");
  const [loading, setLoading] = useState(false);

  const [showNewPassword, setShowNewPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [passwordStrength, setPasswordStrength] = useState("empty");

  const inputsRef = useRef([]);
  const location = useLocation();
  const navigate = useNavigate();

  const email = location.state?.email;

  useEffect(() => {
    inputsRef.current[0]?.focus();
  }, []);

  const updateCode = (index, value) => {
    setCode((prev) => {
      const next = [...prev];
      next[index] = value;
      return next;
    });
  };

  const handleOtpChange = (index, e) => {
    const value = e.target.value.replace(/[^0-9]/g, "");

    if (!value) {
      updateCode(index, "");
      return;
    }

    updateCode(index, value.slice(-1));

    if (index < CODE_LENGTH - 1) {
      inputsRef.current[index + 1]?.focus();
    }
  };

  const handleOtpKeyDown = (index, e) => {
    if (e.key === "Backspace" && !code[index] && index > 0) {
      inputsRef.current[index - 1]?.focus();
    }

    if (e.key === "ArrowLeft" && index > 0) {
      inputsRef.current[index - 1]?.focus();
    }

    if (e.key === "ArrowRight" && index < CODE_LENGTH - 1) {
      inputsRef.current[index + 1]?.focus();
    }
  };

  // محاسبه‌ی قدرت رمز عبور
  const evaluatePasswordStrength = (password) => {
    if (!password) return "empty";

    let score = 0;
    if (password.length >= 8) score++;
    if (/[A-Z]/.test(password)) score++;
    if (/[0-9]/.test(password)) score++;
    if (/[^A-Za-z0-9]/.test(password)) score++;

    if (score <= 1) return "weak";
    if (score === 2 || score === 3) return "medium";
    return "strong";
  };

  const handleNewPasswordChange = (e) => {
    const value = e.target.value;
    setNewPassword(value);
    setPasswordStrength(evaluatePasswordStrength(value));
  };

  const handleConfirmChange = (e) => {
    setConfirm(e.target.value);
  };

  const toggleShowNewPassword = () => {
    setShowNewPassword((prev) => !prev);
  };

  const toggleShowConfirmPassword = () => {
    setShowConfirmPassword((prev) => !prev);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError("");
    setSuccess("");

    const finalCode = code.join("");

    if (!email) {
      setError("no email found for reset");
      return;
    }

    if (finalCode.length !== CODE_LENGTH) {
      setError("code must be 6 digits");
      return;
    }

    if (!newPassword || newPassword.length < 6) {
      setError("password must be at least 6 characters");
      return;
    }

    if (newPassword !== confirm) {
      setError("passwords do not match");
      return;
    }

    try {
      setLoading(true);

      const res = await fetch(
        "http://localhost:8080/api/auth/reset-password",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            email,
            otp: finalCode,
            newPassword,
          }),
        }
      );

      const data = await res.json();
      console.log("RESET PASSWORD RESPONSE:", data);

      if (!res.ok) {
        setError(data.error || "invalid code or password");
        return;
      }

      setSuccess(data.message || "Password reset successfully.");

      setTimeout(() => {
        navigate("/login");
      }, 1000);
    } catch (err) {
      console.error(err);
      setError("there is a problem");
    } finally {
      setLoading(false);
    }
  };

  const goBack = () => {
    navigate("/forgot-password");
  };

  // استایل و متن قدرت پسورد
  const strengthConfig = {
    empty: { label: "", bar: "w-0", color: "bg-transparent" },
    weak: {
      label: "Weak password",
      bar: "w-1/3",
      color: "bg-red-400",
    },
    medium: {
      label: "Medium strength",
      bar: "w-2/3",
      color: "bg-amber-400",
    },
    strong: {
      label: "Strong password",
      bar: "w-full",
      color: "bg-emerald-500",
    },
  };

  const { label, bar, color } = strengthConfig[passwordStrength];

  return (
    <ResetPasswordView
      CODE_LENGTH={CODE_LENGTH}
      code={code}
      inputsRef={inputsRef}
      newPassword={newPassword}
      confirm={confirm}
      error={error}
      success={success}
      loading={loading}
      showNewPassword={showNewPassword}
      showConfirmPassword={showConfirmPassword}
      passwordLabel={label}
      passwordBarClass={bar}
      passwordColorClass={color}
      email={email}
      onOtpChange={handleOtpChange}
      onOtpKeyDown={handleOtpKeyDown}
      onNewPasswordChange={handleNewPasswordChange}
      onConfirmChange={handleConfirmChange}
      onToggleShowNewPassword={toggleShowNewPassword}
      onToggleShowConfirmPassword={toggleShowConfirmPassword}
      onSubmit={handleSubmit}
      onGoBack={goBack}
    />
  );
}
